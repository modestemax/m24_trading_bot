'use strict';
var _ = require('underscore');
var announcer = require('pd-api-announcer');
var q = require('q');


module.exports = function (Record, profile) {
    return q.Promise(function (resolve) {
        var inputs = profile || {};
        var inputFields = Object.keys(inputs) || [];
        var fieldsInCriteria = Record.fieldsInCriteria() || [];
        var fieldsToCheck = _.intersection(inputFields, fieldsInCriteria) || [];
        var wrongField = _.find(fieldsToCheck, function (field) {
            var criteria = Record.inputCriteriaOf(field) || [];
            var fieldValue = profile[field];
            return _.find(criteria, function (criterium) {
                var check = _.isRegExp(criterium) ? function (val) {
                    return criterium.test((val || '') + '');
                } : criterium;
                return !check(fieldValue);
            });
        });
        if (wrongField) {
            throw announcer.error.req(wrongField, 'format');
        }
        resolve();
    });

};