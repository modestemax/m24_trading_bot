'use strict';
var announcer = require('pd-api-announcer');
var q = require('q');
var nomen = require('./nomenclt');

module.exports = function (Child, Parent) {
    var childName = Child.modelName();
    Child[nomen.beKidOf(Parent)] = function (childSid, parentSid) {
        var relKey = nomen.childOf(Child, Parent, parentSid);
        return q.Promise(function (resolve, reject) {
            Child.redis.zsetExists(relKey, childSid).then(function () {
                throw announcer.error.sys(childName, 'already-adopted');
            }).fail(function (err) {
                if (announcer.error(err).isSysFor('zsetItem', 'gone')) {
                    resolve();
                    return;
                }
                reject(err);
            });
        }).then(function () {
            var childProfile = {
                'pd-sid': childSid
            };
            childProfile[nomen.parentSid(Parent)] = parentSid + '';
            return Child.modify(childProfile, function (multis) {
                multis.push(['zadd', relKey, (new Date()).getTime(), childSid]);
                return multis;
            });
        });
    };
};

