'use strict';
var q = require('q');
var a2multi = require('./converter/a2multi');
var defaultCli = require('./default-cli');

var runMulti = function (multiObj) {
    return q.Promise(function (resolve, reject) {
        var exec = function (err, reply) {
            if (err) {
                return reject(err);
            }
            resolve(reply);
        };
        multiObj.exec(exec);
    });
};

module.exports = function (cmdList, cli) {
    return q.Promise(function (rslv) {
        rslv(
            a2multi(cmdList, cli || defaultCli)
        );
    }).then(function (multiObj) {
        return runMulti(multiObj).fail(function (err) {
            multiObj.discard();
            throw err;
        });
    });
};