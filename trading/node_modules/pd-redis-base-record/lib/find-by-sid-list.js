'use strict';
var q = require('q');
var isNeedHash = require('./is-need-hash');

module.exports = function (Record, sidList, option) {
    var opt = option || {};
    var promises = [];
    var recordList = [];
    var each = opt.each || function (record) {
            return record;
        };
    var withCreatedAt = opt.withCreatedAt;
    var getEach = opt.getEach || Record.findBySid;
    var needHash = isNeedHash(opt.fields);
    opt.withCreatedAt = false; //in order to prevent getEach from appending duplicate field
    (sidList || []).forEach(function (sidRec) {
        var sid = sidRec[0];
        var createdAt = parseInt(sidRec[1]);
        promises.push(
            getEach(sid, opt).then(function (record) {
                return each(record);
            }).then(function (record) {
                if (withCreatedAt) {
                    if (needHash) {
                        record.createdAt = createdAt;
                    }
                    else {
                        record.push(createdAt);
                    }
                }
                recordList.push(record);
            })
        );
    });
    return q.allSettled(promises).then(function () {
        return recordList;
    });
};