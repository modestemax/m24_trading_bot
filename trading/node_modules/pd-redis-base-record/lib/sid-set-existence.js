'use strict';
var announcer = require('pd-api-announcer');

var checkExistence = function (Record, sid, forPresence) {
    var nomen = Record.nm;
    var redis = Record.redis;
    var flag = forPresence ? 1 : 0;
    var symptom = forPresence ? 'gone' : 'taken';
    var sidSetKey = nomen.sidSet();
    return redis.exec('zscan', [sidSetKey, 0, 'MATCH', sid])
        .then(function (reply) {
            var foundFlag = (reply[1] || [])[0] === (sid + '') ? 1 : 0;
            if (foundFlag !== flag) {
                throw announcer.error.sys(nomen.modelName(), symptom, sid);
            }
            return reply;
        });
};

module.exports = {
    checkSidSetAbsence: function (Record, sid) {
        return checkExistence(Record, sid, false);
    },
    checkSidSetPresence: function (Record, sid) {
        return checkExistence(Record, sid, true);
    }
};
