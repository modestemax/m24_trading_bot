'use strict';
var q = require('q');
var exec = require('./exec');
var z2a = require('./converter/z2a');
var defaultCli = require('./default-cli');

module.exports = function (scanKey, itemToMatch, command, cli) {
    return q.Promise(function (resolve, reject) {
        var readouts = [];
        var query = function (scan) {
            var cmd = command || 'zscan';
            var redisParams = [scanKey, scan];
            if (itemToMatch) {
                redisParams.splice(2, 0, 'match', itemToMatch);
            }
            var client = cli || defaultCli;
            exec(cmd, redisParams, client).then(function (result) {
                var retScan = parseInt(result[0]);
                (result[1] || []).forEach(function (readout) {
                    readouts.push(readout);
                });
                if (retScan === 0) {
                    resolve(z2a(readouts, cmd === 'zscan'));
                    return;
                }
                if (retScan > 0) {
                    query(retScan);
                }
            }).fail(function (err) {
                reject(err);
            });
        };
        query(0);
    });
};
