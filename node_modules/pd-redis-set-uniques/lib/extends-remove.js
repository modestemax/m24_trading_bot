'use strict';
var q = require('q');

module.exports = function (Record) {
    var oldRemove = Record.remove;
    var nomen = Record.uniqNm;
    var traverseDefs = function (traverser) {
        Record.uniqDefKeys().forEach(traverser);
    };
    Record.remove = function (sid, multiGen) {
        var multiGn = function (multi) {
            var multiArgs = arguments;
            return q.Promise(function (reslv) {
                var promises = [];
                traverseDefs(function (def) {
                    var setKey = nomen.uniqSetOf(def);
                    promises.push(
                        Record.redis.exec('zrangebyscore', [setKey, sid + '', sid + ''])
                            .then(function (result) {
                                (result || []).forEach(function (uid) {
                                    multi.push(['zrem', setKey, uid]);
                                });
                            })
                    );
                });
                reslv(q.allSettled(promises));
            }).then(function () {
                return (multiGen || function (multi) {
                    return multi;
                }).apply(Record, multiArgs);
            });
        };
        return oldRemove.call(Record, sid, multiGn);
    };
};
