'use strict';
var q = require('q');

module.exports = function (Record, option, uniqDef, matchPattern, cursor, count) {
    return Record.matchByUnique(uniqDef, matchPattern, cursor, count).then(function (result) {
        var cursor = result.cursor;
        var opt = option || {};
        var finalList = [];
        var promises = [];
        var each = opt.each || function (record) {
                return record;
            };
        (result.records || []).forEach(function (item) {
            var sid = item[1];
            promises.push(
                Record.findBySid(sid, option).then(function (record) {
                    return each(record);
                }).then(function (record) {
                    if (record) {
                        finalList.push(record);
                    }
                })
            );
        });
        return q.allSettled(promises).then(function () {
            return {
                records: finalList,
                cursor: cursor
            };
        });
    });
};
