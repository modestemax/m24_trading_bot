'use strict';
var q = require('q');
var cramData = require('./cram-data');
var checkAbsence = require('./existence').checkAbsence;

module.exports = function (Record, profile, multiGen) {
    var nomen = Record.nm;
    var redis = Record.redis;
    var autoPid = !profile['pd-sid'];
    return q.Promise(function (reslv) {
        reslv(autoPid ? redis.exec('incr', nomen.sidValue()).then(function (sid) {
            profile['pd-sid'] = sid;
            return sid;
        }) : profile['pd-sid']);
    }).then(function (sid) {
        return cramData(Record, profile, {
            multis: function (primKeys, profile) {
                return q.Promise(function (rslv) {
                    var multiList = [];
                    multiList.push(['zadd', nomen.sidSet(), (new Date()).getTime(), sid]);
                    multiList.push(['hmset', nomen.dataForSid(sid), profile]);
                    rslv(multiList);
                }).then(function (multis) {
                    var finalMGen = multiGen || function (multis) {
                            return multis;
                        };
                    return finalMGen(multis, profile);
                });
            },
            existence: checkAbsence
        }).then(function () {
            return sid;
        });
    });
};
