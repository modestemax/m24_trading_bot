'use strict';
var q = require('q');
var _ = require('underscore');
var cramData = require('./cram-data');
var checkPresence = require('./existence').checkPresence;

module.exports = function (Record, profile, multiGen) {
    var nomen = Record.nm;
    return cramData(Record, profile, {
        multis: function (sid) {
            return q.Promise(function (rslv) {
                var updates = ['hmset', nomen.dataForSid(sid)];
                _.filter(Object.keys(profile), function (key) {
                    return key !== 'pd-sid'; //Prevent sid field from being modified
                }).forEach(function (key) {
                    updates.push(key);
                    updates.push(profile[key]);
                });
                updates.push('updatedAt', (new Date()).getTime());
                rslv([updates]);
            }).then(function (multis) {
                var finalMGen = multiGen || function (multis) {
                        return multis;
                    };
                return finalMGen(multis, profile);
            });
        },
        existence: checkPresence
    });
};
