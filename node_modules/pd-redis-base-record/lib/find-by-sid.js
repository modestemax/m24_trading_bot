'use strict';
var isNeedHash = require('./is-need-hash');

module.exports = function (Record, sid, option) {
    var opt = option || {};
    var nomen = Record.nm;
    var redis = Record.redis;
    var needToGetAll = isNeedHash(opt.fields);
    var fields = opt.fields || [];
    var withCreatedAt = opt.withCreatedAt;

    var cmd = needToGetAll ? 'hgetall' : 'hmget';
    var dataKey = nomen.dataForSid(sid);
    return redis.exec(cmd, [dataKey].concat(fields)).then(function (record) {
        var sidSetKey = nomen.sidSet();
        var getCreatedAt = function () {
            return redis.exec('zscore', [sidSetKey, sid + ''])
                .then(function (score) {
                    var ts = parseInt(score);
                    return (needToGetAll ? function () {
                        record.createdAt = ts;
                        return record;
                    } : function () {
                        record.push(ts);
                        return record;
                    })();
                });
        };
        return withCreatedAt ? getCreatedAt() : record;
    });
};
